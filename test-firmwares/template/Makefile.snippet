# ChibiOS Makefile Snippet for Bootloader Integration
# Copy these changes to your ChibiOS project Makefile

# ==============================================================================
# STEP 1: Change linker script (around line 124)
# ==============================================================================

# BEFORE:
# LDSCRIPT= $(STARTUPLD)/STM32C071xB.ld

# AFTER:
LDSCRIPT= STM32C071xB_bootloader.ld


# ==============================================================================
# STEP 2: Add app_header.c to sources (around line 128)
# ==============================================================================

# BEFORE:
# CSRC = $(ALLCSRC) \
#        $(TESTSRC) \
#        main.c

# AFTER:
CSRC = $(ALLCSRC) \
       $(TESTSRC) \
       main.c \
       app_header.c


# ==============================================================================
# STEP 3: Add automatic signing (at end of Makefile, in Custom rules section)
# ==============================================================================

# Path to signing script (adjust based on your project location)
SIGN_SCRIPT = ../../../scripts/sign_app_header.sh

# Automatic post-build signing
POST_MAKE_ALL_RULE_HOOK: sign_firmware

sign_firmware: $(BUILDDIR)/$(PROJECT).bin
	@echo ""
	@echo "=========================================="
	@echo "Signing firmware with size and CRC32..."
	@echo "=========================================="
    @bash $(SIGN_SCRIPT) $(BUILDDIR)/$(PROJECT).bin $(BUILDDIR)/$(PROJECT)_signed.bin
	@echo ""
	@echo "âœ“ Build and signing complete!"
	@echo "  Unsigned: $(BUILDDIR)/$(PROJECT).bin (do not upload)"
	@echo "  Signed:   $(BUILDDIR)/$(PROJECT)_signed.bin (ready to upload)"
	@echo ""

.PHONY: sign_firmware


# ==============================================================================
# STEP 4: Add app_header.h include to main.c
# ==============================================================================

# Add this line to your main.c includes:
# #include "app_header.h"

# That's it! Run 'make' and it will automatically sign the firmware.
